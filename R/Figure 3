#Figure 3
#3B: Scorer function (Paper code file)

#3C-F- GO BP and pathway enrichment for dynamic, partially dynamic and stable genes
library (hypeR)
library(msigdbr)
#download genesets
biocarta <- msigdb_gsets(species="Mus musculus", category="C2", subcategory = "CP:BIOCARTA")
kegg <- msigdb_gsets(species="Mus musculus", category="C2", subcategory = "CP:KEGG")
reactome <- msigdb_gsets(species="Mus musculus", category="C2", subcategory = "CP:REACTOME")
paths<- c(biocarta$genesets, kegg$genesets, reactome$genesets)
GOBP <- msigdb_gsets(species="Mus musculus", category="C5", subcategory = "BP")

#scores: Table S2 
#pathway and BP enrichment for dynamic genes in STAU2 cargo
dynamic<-scores[which(exp(scores$summed.ln(BF))>=100),] 
dyn_paths<- hypeR(as.character (dynamic$Gene.Name), paths, background=55487, fdr=0.01)
dyn_paths<- dyn_paths$data[,1:8]
dyn_paths<- hypeR(as.character (dynamic$Gene.Name), GOBP, background=55487, fdr=0.01)
dyn_bp<- dynamic_bp$data[,1:8]

#pathway and BP enrichment for partially dynamic genes in STAU2 cargo
partially.dynamic<- scores[which(exp(scores$summed.ln(BF))<100 & exp(scores$summed.ln(BF))>=3),]
par.dyn_paths<- hypeR(as.character (partially.dynamic$Gene.Name), paths, background=55487, fdr=0.01)
par.dyn_paths<- partially.dynamic_paths$data[,1:8]
par.dyn_bp<- hypeR(as.character (partially.dynamic$Gene.Name), GOBP, background=55487, fdr=0.01)
par.dyn_bp<- partially.dynamic_bp$data[,1:8]

#pathway and BP enrichment for strongly stable genes in STAU2 cargo
stable_strong<-scores[which(exp(scores$summed.ln(BF))<0.33),]
stable_strong_paths<- hypeR(as.character (stable_strong$Gene.Name), paths, background=55487, fdr=0.01)
stable_strong_paths<- stable_strong_paths$data[,1:8]
stable_strong_bp<- hypeR(as.character (stable_strong$Gene.Name), GOBP, background=55487, fdr=0.01)
stable_strong_bp<- stable_strong_bp$data[,1:8]

#unique pathways for dynamic genes in STAU2 cargo
dyn_not_stable_strong<- anti_join(dyn_paths, stable_strong_paths, by="label")
#unique pathways for strongly stable genes in STAU2 cargo
stable_strong_not_dynamic<- anti_join(stable_strong_paths, dyn_paths, by="label")
#unique bp for dynamic genes in STAU2 cargo
dyn_not_stable_strong_bp<- anti_join(dyn_bp, stable_strong_bp, by="label")
#unique bp for strongly stable in STAU2 cargo
stable_strong_not_dyn_bp<- anti_join(stable_strong_bp, dyn_bp, by="label")

#plotting
#using dfs generated above eg. dyn_paths, stable_strong_paths, etc
hyp_plot2<-function(df,top=15,main="Top Categories",fills=c("black","gray")){
  df.1 <- head(df, top)
  df.2 <- df.1
  df.2$log.fdr <- -log10(df.1$fdr)
  df.2$Contribution <- df.1$overlap/df.1$geneset * df.2$log.fdr #calculates the contribution of df genes to the category
  df.2$x1 <- df.2$log.fdr - df.2$Contribution #adds a column x1 
  df.3<-df.2[,c("label","Contribution")] #new df with only category and contribution columns
  df.3$Membership<-rep("Cargo",top) #top<- 10 #assigns the top categories for genes in cargo
  df.4<-df.2[,c("label","x1")] #new df x1 that represents remaining genes in category
  colnames(df.4)<-c("label","Contribution")
  df.4$Membership<-rep("Not Cargo",top) #assigns top categories for remaining genes in category
  df.2<-rbind(df.4,df.3) #new matrix consisting of genes in cargo and remaining genes in category
  df.2$label<-strwrap(df.2$label,width=30) 
  #bar graph to plot top 15 categories
  df.2$label<- factor(df.2$label, levels=df.2[1:15,]$label)
  p1<- ggplot(df.2,aes(y = Contribution, x = label)) + theme_bw() + theme(axis.text=element_text(size=10))
  p1<- p1 + geom_col(aes(fill=Membership))+coord_flip()
  p1<- p1 + theme(legend.position="bottom", legend.direction="horizontal") +scale_fill_discrete(name="Percent of Category")
  p1<- p1 + scale_fill_manual(values=fills)
  p1<- p1+ labs(x=element_blank(), y="log(FDR)") + theme(legend.text=element_text(size=10))
  p1<- p1 + labs(title=main) + theme(plot.title=element_text(hjust=0)) +xlab("log(FDR)")
  p1
}
